/*
 * LCD5110.c
 *
 * Created: 28. 12. 2015
 *  Author: Andy F
 */ 

#define F_CPU 8000000UL

#define BUZZER 3
#define BL 0
#define RST 6
#define DC 7



#include <avr/io.h>
#include <avr/pgmspace.h>
#include <util/delay.h>
#include <math.h>

//field of chars
const unsigned char ZNAK[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00,// (space)
	0x00, 0x00, 0x5F, 0x00, 0x00,// !
	0x00, 0x07, 0x00, 0x07, 0x00,// "
	0x14, 0x7F, 0x14, 0x7F, 0x14,// #
	0x24, 0x2A, 0x7F, 0x2A, 0x12,// $
	0x23, 0x13, 0x08, 0x64, 0x62,// %
	0x36, 0x49, 0x55, 0x22, 0x50,// &
	0x00, 0x05, 0x03, 0x00, 0x00,// '
	0x00, 0x1C, 0x22, 0x41, 0x00,// (
	0x00, 0x41, 0x22, 0x1C, 0x00,// )
	0x08, 0x2A, 0x1C, 0x2A, 0x08,// *
	0x08, 0x08, 0x3E, 0x08, 0x08,// +
	0x00, 0x50, 0x30, 0x00, 0x00,// ,
	0x08, 0x08, 0x08, 0x08, 0x08,// -
	0x00, 0x60, 0x60, 0x00, 0x00,// .
	0x20, 0x10, 0x08, 0x04, 0x02,// /
	0x3E, 0x51, 0x49, 0x45, 0x3E,// 0
	0x00, 0x42, 0x7F, 0x40, 0x00,// 1
	0x42, 0x61, 0x51, 0x49, 0x46,// 2
	0x21, 0x41, 0x45, 0x4B, 0x31,// 3
	0x18, 0x14, 0x12, 0x7F, 0x10,// 4
	0x27, 0x45, 0x45, 0x45, 0x39,// 5
	0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
	0x01, 0x71, 0x09, 0x05, 0x03,// 7
	0x36, 0x49, 0x49, 0x49, 0x36,// 8
	0x06, 0x49, 0x49, 0x29, 0x1E,// 9
	0x00, 0x36, 0x36, 0x00, 0x00,// :
	0x00, 0x56, 0x36, 0x00, 0x00,// ;
	0x00, 0x08, 0x14, 0x22, 0x41,// <
	0x14, 0x14, 0x14, 0x14, 0x14,// =
	0x41, 0x22, 0x14, 0x08, 0x00,// >
	0x02, 0x01, 0x51, 0x09, 0x06,// ?
	0x32, 0x49, 0x79, 0x41, 0x3E,// @
	0x7E, 0x11, 0x11, 0x11, 0x7E,// A
	0x7F, 0x49, 0x49, 0x49, 0x36,// B
	0x3E, 0x41, 0x41, 0x41, 0x22,// C
	0x7F, 0x41, 0x41, 0x22, 0x1C,// D
	0x7F, 0x49, 0x49, 0x49, 0x41,// E
	0x7F, 0x09, 0x09, 0x01, 0x01,// F
	0x3E, 0x41, 0x41, 0x51, 0x32,// G
	0x7F, 0x08, 0x08, 0x08, 0x7F,// H
	0x00, 0x41, 0x7F, 0x41, 0x00,// I
	0x20, 0x40, 0x41, 0x3F, 0x01,// J
	0x7F, 0x08, 0x14, 0x22, 0x41,// K
	0x7F, 0x40, 0x40, 0x40, 0x40,// L
	0x7F, 0x02, 0x04, 0x02, 0x7F,// M
	0x7F, 0x04, 0x08, 0x10, 0x7F,// N
	0x3E, 0x41, 0x41, 0x41, 0x3E,// O
	0x7F, 0x09, 0x09, 0x09, 0x06,// P
	0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
	0x7F, 0x09, 0x19, 0x29, 0x46,// R
	0x46, 0x49, 0x49, 0x49, 0x31,// S
	0x01, 0x01, 0x7F, 0x01, 0x01,// T
	0x3F, 0x40, 0x40, 0x40, 0x3F,// U
	0x1F, 0x20, 0x40, 0x20, 0x1F,// V
	0x7F, 0x20, 0x18, 0x20, 0x7F,// W
	0x63, 0x14, 0x08, 0x14, 0x63,// X
	0x03, 0x04, 0x78, 0x04, 0x03,// Y
	0x61, 0x51, 0x49, 0x45, 0x43,// Z
	0x00, 0x00, 0x7F, 0x41, 0x41,// [
	0x02, 0x04, 0x08, 0x10, 0x20,// "\"
	0x41, 0x41, 0x7F, 0x00, 0x00,// ]
	0x04, 0x02, 0x01, 0x02, 0x04,// ^
	0x40, 0x40, 0x40, 0x40, 0x40,// _
	0x00, 0x01, 0x02, 0x04, 0x00,// `
	0x20, 0x54, 0x54, 0x54, 0x78,// a
	0x7F, 0x48, 0x44, 0x44, 0x38,// b
	0x38, 0x44, 0x44, 0x44, 0x20,// c
	0x38, 0x44, 0x44, 0x48, 0x7F,// d
	0x38, 0x54, 0x54, 0x54, 0x18,// e
	0x08, 0x7E, 0x09, 0x01, 0x02,// f
	0x08, 0x14, 0x54, 0x54, 0x3C,// g
	0x7F, 0x08, 0x04, 0x04, 0x78,// h
	0x00, 0x44, 0x7D, 0x40, 0x00,// i
	0x20, 0x40, 0x44, 0x3D, 0x00,// j
	0x00, 0x7F, 0x10, 0x28, 0x44,// k
	0x00, 0x41, 0x7F, 0x40, 0x00,// l
	0x7C, 0x04, 0x18, 0x04, 0x78,// m
	0x7C, 0x08, 0x04, 0x04, 0x78,// n
	0x38, 0x44, 0x44, 0x44, 0x38,// o
	0x7C, 0x14, 0x14, 0x14, 0x08,// p
	0x08, 0x14, 0x14, 0x18, 0x7C,// q
	0x7C, 0x08, 0x04, 0x04, 0x08,// r
	0x48, 0x54, 0x54, 0x54, 0x20,// s
	0x04, 0x3F, 0x44, 0x40, 0x20,// t
	0x3C, 0x40, 0x40, 0x20, 0x7C,// u
	0x1C, 0x20, 0x40, 0x20, 0x1C,// v
	0x3C, 0x40, 0x30, 0x40, 0x3C,// w
	0x44, 0x28, 0x10, 0x28, 0x44,// x
	0x0C, 0x50, 0x50, 0x50, 0x3C,// y
	0x44, 0x64, 0x54, 0x4C, 0x44,// z
};

//very important field - there is all pixels of the display
unsigned char canvas [504];
//if you want to repaint the LCD display
char repaint;

void pin(int* port, int no, int val) {
	if(val)
		*port |= (1<<no);
	else
		*port &= ~(1<<no);
}

void lcdCmd(int cmd) {
	pin(&PORTD, DC, 0);		//DC pin is low for commands
	SPDR = cmd;				//transmit serial data
	while(!(SPSR & (1<<SPIF)))
		;
}

void lcdData(int data) {
	pin(&PORTD, DC, 1);		//DC pin is high for data
	SPDR = data;				//transmit serial data
	while(!(SPSR & (1<<SPIF)))
		;
}

//go to position x and y on the display
void gotoXY(int x, int y) {
	if(x >= 0 && x < 84)
		lcdCmd(0x80 | x);
	if(y >= 0 && y < 6)
		lcdCmd(0x40 | y);
}

//draw single point
void drawPoint(char x, char y) {
	if(x > 84 || y > 48)
		return;
	
	canvas[(y/8)*84 + x] |= (1<<(y%8));
	repaint = 1;
}

//draw the rectangle (left, top, right, bottom position and full - 1,2,3,4, see main() function
void drawRect(char l, char t, char r, char b, char full) {
	int i, j;
	for(i = l; i < r; i++) {
		for(j = t; j < b; j++) {
			if(full == 2 || i==l || j==t || i==r-1 || j==b-1 || (full>2 && (i%(full>3? 2 : 3))^(j%2)==1))
				drawPoint(i, j);
		}			
	}
}

//draw circle to the position cx and cy with radius r 
void drawCircle(char cx, char cy, float r) {
	int i, j;
	int qr = r*r;
	for(i = -r; i < r; i++) {
		for(j = -r; j < r; j++) {
			if(i*i + j*j < qr)
				drawPoint(i+cx, j+cy);
		}			
	}
}

//draw the text directly to the display (not to the field "canvas")
void drawText(char * text) {
	int i, j;
	for(i = 0; text[i] != 0; i++) {
		for(j = 0; j < 5; j++) {
			lcdData(pgm_read_byte(&ZNAK[(text[i]-0x20)*5+j]));
		}
		lcdData(0x00);
	}
}

//clean up the field "canvas"
void cleanUp() {
	int i;
	for(i = 0; i < 504; i++)
		canvas[i] = 0;
}

//turn the buzzer on for time (longBeep can be 1 or 0)
void beep(int longBeep) {
	pin(&PORTC, BUZZER, 0);
	if(longBeep)
		_delay_ms(400);
	else
		_delay_ms(50);
	pin(&PORTC, BUZZER, 1);
}

int main(void)
{
	int i;
	float ballx = 10, bally = 30;
	pin(&PORTC, BUZZER, 1);
	DDRD = 0b11000001;
	DDRC =   0b001000;
	DDRB = 0b00101100;
	PORTD = PORTD|(1<<1)|(1<<3)|(1<<4);
	SPCR = 0b01010001;
	pin(&PORTD, RST, 0);
	_delay_ms(5);
	pin(&PORTD, RST, 1);
	lcdCmd(0x21); // LCD extended commands
	lcdCmd(0xBC); // set LCD Vop (contrast)
	lcdCmd(0x04); // set temp coefficent
	lcdCmd(0x14); // LCD bias mode 1:40
	lcdCmd(0x20); // LCD basic commands
	lcdCmd(0x0C); // LCD normal video mode
	
	for(i = 0; i < 504; i++)
		lcdData(0x00);
	pin(&PORTD, BL, 1);
	gotoXY(18, 1);
	drawText("LCD 5110");
	gotoXY(21, 2);
	drawText("example");
	gotoXY(15, 4);
	drawText("by Andy F");
	_delay_ms(3500);
	
	
	repaint = 1;
	while(1) {
		if(repaint) {
			gotoXY(0, 0);
			//draw the data from field "canvas" to the display
			for(i = 0; i < 504; i++)
				lcdData(canvas[i]);
			//and draw some text
			gotoXY(24, 2);
			drawText("Hello!");
			//now the display is repainted, so clear variable repaint
			repaint = 0;
			cleanUp();
		}
		
		//some actions and drawing, for example:
		drawCircle(ballx, bally, 2.7);
		drawRect(0, 33, 84, 38, 1);
		//types of rectangles:
		drawRect(1, 40, 21, 48, 1);
		drawRect(22, 40, 42, 48, 2);
		drawRect(43, 40, 63, 48, 3);
		drawRect(64, 40, 83, 48, 4);
		ballx++;
		if(ballx > 89) {
			ballx = -5;
			beep(0);
		}		
		//re-draw the image on the display
		repaint = 1;
		
		_delay_ms(10);
	}
}
